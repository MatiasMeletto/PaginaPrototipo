@page "/pedido"

<header class="masthead bg-primary text-white text-center">
    <div class="container d-flex align-items-center flex-column">
        <h3>Pedido</h3>
        @if (pedidos == null)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            <ul>
                @foreach (var pedido in pedidos)
                {
                    <li>
                        <p class="">Su pedido n° @pedido.PedidoId es:</p>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Adicionales</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var producto in Model.Productos.Where(c => c.PedidoId == pedido.PedidoId))
                                {
                                    <tr>
                                        <td>@producto.Nombre</td>
                                        <td>@producto.Cantidad</td>
                                        <td>@producto.Precio</td>
                                        <td>@producto.Adicionales</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </li>
                }
            </ul>
        }
    </div>
</header>

@code {

    private class CarritoViewModel
    {
        public decimal Total
        {
            get
            {
                return Productos.Sum(p => p.Precio);
            }
        }
        public List<ProductoViewModel> Productos { get; set; } = new List<ProductoViewModel>();
    }

    private class ProductoViewModel
    {
        public string Nombre { get; set; }
        public int Cantidad { get; set; }
        public int Precio { get; set; }
        public string Adicionales { get; set; }
        public int PedidoId { get; set; }
    }

    private CarritoViewModel Model { get; set; } = new();

    private PedidoProducto[]? productos;

    private Pedido[]? pedidos;

    protected override async Task OnInitializedAsync()
    {
        using var db = new CompraContext();

        pedidos = db.Pedidos
        .Include(c => c.Productos)
        .Include(c => c.Usuario).ToArray();

        productos = db.PedidoProductos
        .Include(c => c.Producto)
        .Include(c => c.Pedido)
        .Include(p => p.Adicionales)
        .ThenInclude(p => p.Adicional).ToArray();

        foreach (var producto in productos)
        {
            ProductoViewModel productoViewModel = new ProductoViewModel
                {
                    Cantidad = producto.Cantidad,
                    Nombre = producto.Producto.Nombre,
                    Precio = producto.Precio,
                    PedidoId = producto.PedidoId
                };
            foreach (var adicional in producto.Adicionales)
            {
                productoViewModel.Adicionales += $"{adicional.Adicional.Nombre} ({adicional.Cantidad})";
                if (producto.Adicionales.Last() == adicional)
                {
                    productoViewModel.Adicionales += ".";
                }
                else
                {
                    productoViewModel.Adicionales += ", ";
                }
            }
            Model.Productos.Add(productoViewModel);
        }
    }
}

